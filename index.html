<template>
  <view class="page-register">
      <view wx:if="{{warnMsg.length}}" class="warnMsg ellitext">{{warnMsg}}</view>
      <view class="reg-header">验证手机</view>
      <view class="reg-form">
          <view class="form-mobile">
              <view class='lf'>+86</view>
              <view class="triangle"></view>
              <input class="mobile" type="text" maxlength="11" placeholder="请输入手机号" bindinput="bindReplaceInput(mobile)" bindblur="bindBlurInput(mobile)">
          </view>
          <!-- <view class="form-code">
              <view class="code-lf">
                <input class="code" type="text" placeholder="请输入验证码" bindinput="bindReplaceInput(code)" bindblur="bindBlurInput(code)">
                <image wx:if="{{validate.code==1}}" src="../../images/warn.png" style="width:48rpx;height:48rpx;" />
                <image wx:if="{{validate.code==2}}" src="../../images/success.png" style="width:48rpx;height:48rpx;" />
                <image wx:if="{{validate.code==3}}" src="../../images/loading.gif" style="width:48rpx;height:48rpx;" />
              </view>
              <view @tap="getImgCode" class="code-rt">
                  <image src="{{imgCode}}" style="width:227rpx;height:75rpx;" />
              </view>
          </view> -->
          <view class="form-msgcode">
              <view class="msgcode-lf">
                  <view class='lf'>验证码</view>
                  <input class="msgcode" type="number" maxlength="6" placeholder="请输入验证码" bindinput="bindReplaceInput(msgcode)" bindblur="bindBlurInput(msgcode)">
              </view>
              <view wx:if="{{!countDown}}" class="msgcode-rt" @tap="getCode">
                  获取验证码
              </view>
              <view wx:else class="msgcode-rt">
                  倒计时({{count}}s)
              </view>
          </view>
          <view @tap="getCodeNext" class="form-submit">下一步</view>
      </view>
  </view>
</template>
<style lang="less">
.page-register {
  // overflow: hidden;
  .warnMsg {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    padding: 0 30rpx;
    height: 80rpx;
    line-height: 80rpx;
    text-align: center;
    background-color: #ff6376;
    font-size: 30rpx;
    color: #ffffff;
  }
  .reg-header {
    height: 90rpx;
    line-height: 90rpx;
    font-size: 60rpx;
    color: #121213;
    margin: 100rpx 54rpx 46rpx;
  }
  .reg-form {
    margin: 0 54rpx;
    .form-mobile,
    .form-password {
      height: 100rpx;
      display: flex;
      align-items: center;
      background-color: #f7f7f7;
      padding: 0 25rpx 0 34rpx;
      margin-bottom: 30rpx;
      border-radius: 50rpx;
      .lf {
        color: #121213;
        font-size: 30rpx;
      }
      .triangle {
        width: 0;
        height: 0;
        border: 10rpx solid transparent;
        border-top: 10rpx solid #dad9e2;
        margin: 10rpx 26rpx 0 12rpx;
      }
      .mobile,
      .password {
        font-size: 30rpx;
        color: #121213;
        height: 30rpx;
        line-height: 30rpx;
        flex: 1;
      }
      image {
        display: block;
        flex-shrink: 0;
      }
    }
    .form-code,
    .form-msgcode {
      height: 100rpx;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 50rpx;
      .code-lf,
      .msgcode-lf {
        flex: 1;
        height: 100rpx;
        display: flex;
        align-items: center;
        background-color: #f7f7f7;
        padding: 0 25rpx 0 34rpx;
        margin-right: 24rpx;
        border-radius: 50rpx;
        .lf {
          color: #121213;
          font-size: 30rpx;
          margin-right: 24rpx;
          flex-shrink: 0;
        }
        .code,
        .msgcode {
          font-size: 30rpx;
          color: #333;
          height: 30rpx;
          line-height: 30rpx;
          flex: 1;
        }
        image {
          display: block;
          flex-shrink: 0;
        }
      }
      .code-rt,
      .msgcode-rt {
        flex-shrink: 0;
        width: 200rpx;
        height: 100rpx;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .msgcode-rt {
        background-color: #a2a8b2;
        border-radius: 50rpx;
        font-size: 30rpx;
        color: #ffffff;
      }
    }
    .form-submit {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100rpx;
      background: #8fc6c3;
      border-radius: 50rpx;
      font-size: 30rpx;
      color: #fff;
      box-shadow: 0px 10rpx 40rpx 0px #e8f0fa;
    }
  }
}
</style>
<script>
import { tool, api, wepy } from "@/common";
import { wxRequest } from "@/utils/wxRequest";
// import orderList from "../../components/order-list";

export default class Register extends wepy.page {
  config = {
    navigationBarTitleText: "验证手机"
  };
  data = {
    warnMsg: "",
    countDown: false, // 是否开始倒计时
    count: 60, // 倒计时
    temp: {
      mobile: "",
      password: "",
      code: "",
      msgcode: ""
    },
    temps: { phone: "" },
    phone: {
      phone: "",
      code: "",
      imageCode: "",
      userId: ""
    },
    imgCode: "",
    validate: {
      mobile: "", //1:未通过,2:已通过,3:判断中
      password: "", //1:未通过,2:已通过,3:判断中
      code: "", //1:未通过,2:已通过,3:判断中
      msgcode: "" //1:未通过,2:已通过,3:判断中
    },
    imgBase64: "data:image/jpeg;base64",
    imgCodeYz: { imgCode: "", userId: "" },
    imgCodes: "",
    userIds: "",
    imgCodeYzDx: {
      phone: "",
      code: ""
    }
  };
  methods = {
    bindBlurInput(e) {
      this.vilidateInput(e)
    },
    bindReplaceInput(type, e) {
      this.temp[type] = e.detail.value;
    },
    getCode() {
      if (this.vilidateInput('mobile')) {
        this.temps.phone = this.temp.mobile;
        var _this = this;
        wxRequest(
          {
            query: this.temps,
            method: "GET"
          },
          `${api.sendCode}`
        ).then(res => {
          if (res.success) {
            _this.countDown = true;
            _this.count = 60;
            var timer = setInterval(function() {
              _this.count = _this.count - 1;
              if (_this.count < 0) {
                _this.countDown = false;
                clearInterval(timer);
              }
              _this.$apply();
            }, 1000);
          } else {
            // console.log(res);
          }
          _this.$apply();
        });
      }
    },
    getImgCode() {
      this.validate.code = 1;
      this.userIds = wx.getStorageSync("userId");
      let time = new Date();
      this.imgCode = `${api.getImgCode}?userId=${
        this.userIds
      }&time=${time.valueOf()}`;
      this.$apply();
    },
    getCodeNext() {
      if (this.vilidateInput('mobile') && this.vilidateInput('msgcode')) {
        this.phone.phone = this.temp.mobile;
        this.phone.code = this.temp.msgcode;
        this.phone.userId = wx.getStorageSync("userId");
        wxRequest(
          {
            query: this.phone,
            method: "GET"
          },
          `${api.register}`
        ).then(res => {
          if (res.success) {
            wx.setStorageSync("userPhone", this.temp.mobile);
            wx.navigateBack();
          } else {
            // this.temp.code =  ""; // 图片验证码重置为空
            // this
          }
        });
      }
    }
  };
  vilidateInput(e) {
    switch (e) {
      case "mobile":
        var reg = /^1\d{10}$/;
        if (reg.test(this.temp.mobile)) {
          this.warnMsg = "";
          return true;
        } else {
          this.warnMsg = "手机号格式不正确";
          return false;
        }
        break;
      case "msgcode":
        var reg = /^\d+$/;
        if (reg.test(this.temp.msgcode)) {
          this.warnMsg = "";
          return true;
        } else {
          this.warnMsg = "短信验证码格式错误";
          return false;
        }
        break;
    }
  }
  onShow() {
    this.userIds = wx.getStorageSync("userId");
    this.imgCode = `${api.getImgCode}?userId=${this.userIds}`;
    this.$apply();
  }
}
</script>

